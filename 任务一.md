## 准备编译环境
### 安装必须依赖
本机环境为
安装所需的依赖，如`gcc`、`make`、`autoconf` 等。
```bash
sudo apt-get update
sudo apt-get install -y build-essential autoconf zip unzip libx11-dev libxext-dev libxrender-dev libxtst-dev libcups2-dev libasound2-dev ccache libfontconfig1-dev libfreetype6-dev

```
### 安装 Boot JDK
编译 JDK 需要一个现有的 JDK 作为引导 JDK（boot JDK）。
```bash
sudo apt-get install -y openjdk-17-jdk

```
安装后使用 java -version 验证
![[Pasted image 20240827001038.png]]

### 编译 Tencent JDK
#### clone 后配置编译选项
在源码目录中，运行 `configure` 脚本来配置编译选项。启用 Shenandoah GC 可以通过指定相关的选项：
```bash
bash configure --with-jvm-features=shenandoahgc --with-boot-jdk=/usr/lib/jvm/java-17-openjdk-amd64`
```
- `--with-jvm-features=shenandoahgc`：启用 Shenandoah GC。
- `--with-boot-jdk`：指定引导 JDK 的路径，确保使用已安装的 JDK 路径。

![[Pasted image 20240827001319.png]]
报错，按照提示重新安装

![[Pasted image 20240827001631.png]]
成功配置 shenandoahgc，且观察发现配置为 4 核 8G

#### 开始编译
![[Pasted image 20240827001813.png]]
编译成功
![[Pasted image 20240827003044.png]]
编译后的目录
![[Pasted image 20240827003527.png]]
#### 验证
进入 `build/linux-x86_64-server-release` 目录，查看是否有 `images/jdk` 子目录，里面应该有完整的 JDK 发行版，包括 `bin`, `lib` 等子目录。
![[Pasted image 20240827003613.png]]
可以看到基础是 OpenJDK，构建版本来源于 TencentJDK
![[Pasted image 20240827003650.png]]
验证**Shenandoah GC**：
![[Pasted image 20240827003744.png]]
结果为 true，成功启用

## 测试
将自编译 JDK 加入到环境变量中
```bash
echo 'export PATH=/java/TencentKona-17/build/linux-x86_64-server-release/jdk/bin:$PATH' >> ~/.bashrc 
source ~/.bashrc
```
![[Pasted image 20240828001400.png]]
验证成功

上传 GCTest 
```java
import java.util.ArrayList;
import java.util.List;

public class GCTest {
    public static void main(String[] args) {
        List<byte[]> objects = new ArrayList<>();

        // 无限循环，持续创建对象
        while (true) {
            // 每次创建一个10MB的对象
            objects.add(new byte[10 * 1024 * 1024]);

            // 控制对象数量，防止过快OOM
            if (objects.size() > 1000) {
                objects.subList(0, 500).clear();
            }

            try {
                // 模拟一些计算，避免空转
                Thread.sleep(50);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}


```
编译程序
![[Pasted image 20240828001540.png]]

### 估测
假设虚拟机内存为 512M
**年轻代与老年代的比例**: 默认比例通常为 1:2，意味着年轻代占 1/3（约 170MB），老年代占 2/3（约 340MB）
假设新生代的 Eden 区占用 80% 的年轻代空间
建立 10 个对象左右就会触发一次 Minor GC

### 实际测试
命令行：
```bash
java -Xmx512m -XX:+UseG1GC -Xlog:gc*:g1gc.log -Xlog:gc+phases=debug:file=gc.log:tags,uptime,time,level,tags:filecount=1,filesize=0 GCTest

java -Xmx512m -XX:+UseZGC -Xlog:gc*:zgc.log -Xlog:gc+phases=debug:file=gc.log:tags,uptime,time,level,tags:filecount=1,filesize=0 GCTest

java -Xmx512m -XX:+UseShenandoahGC -Xlog:shengc*:gc.log -Xlog:gc+phases=debug:file=shengc.log:tags,uptime,time,level GCTest

java -Xmx512m -XX:+UseSerialGC -Xlog:gc*:serialgc.log GCTest

java -Xmx512m -XX:+UseParallelGC -Xlog:gc*:parrallgc.log GCTest
```

![[Pasted image 20240828232433.png]]
都会 OOM
得到三个 GC 的日志文件，下载下来分析

#### Serial

![[Pasted image 20240829233942.png]]
年轻代和老年代占比符合预期
总体时间:
3 sec 779 ms
![[Pasted image 20240829234339.png]]
GC 总时间：784ms
![[Pasted image 20240829234025.png]]
吞吐量接近 80%，平均暂停时间和最大暂停时间都较长
![[Pasted image 20240829234055.png]]
整体内存使用情况，梯度上升

#### Parallel
![[Pasted image 20240829233852.png]]
内存差别不大
总体时间：
3 sec 829 ms
![[Pasted image 20240829234623.png]]
GC 总时间 720ms

![[Pasted image 20240829234444.png]]
吞吐量比串行略大
最大 gc 暂停时长有所下降，整体时间相对更快
![[Pasted image 20240829234547.png]]
内存使用情况上升较缓
#### G1
![[Pasted image 20240828234208.png]]
最后日志中断，OOM
![[Pasted image 20240829002030.png]]
年轻代与老年代比例符合预期
总体时间：
3 sec 173 ms

![[Pasted image 20240829234926.png]]

stw 时间 158ms，相对短
![[Pasted image 20240829234816.png]]
并发的回收占比很高
![[Pasted image 20240829002113.png]]
平均时间较为优异，保持 10ms


#### ZGC
![[Pasted image 20240828234900.png]]

![[Pasted image 20240828234912.png]]
触发了 OOM
![[Pasted image 20240829002522.png]]
内存利用更大

总时间：
3 sec 101 ms
![[Pasted image 20240829235055.png]]
极低的暂停时间
![[Pasted image 20240829235111.png]]
几乎全部是并发


![[Pasted image 20240829002823.png]]
吞吐量非常高，stw 时间很短
![[Pasted image 20240829002854.png]]
堆内存使用阶梯式上升
![[Pasted image 20240829002928.png]]

#### shennadoah
![[Pasted image 20240829001020.png]]
分析
![[Pasted image 20240829001543.png]]
最大利用为 471mb


![[Pasted image 20240829002508.png]]
内存利用情况

总时间：
3 sec 573 ms

![[Pasted image 20240829235310.png]]
总暂停时间 451ms
![[Pasted image 20240829001616.png]]
stw 时间平均值和最大值差异极大，吞吐量为 87 左右

![[Pasted image 20240829001621.png]]

![[Pasted image 20240829001749.png]]
到后期全部是退化 GC，并行阶段大幅减少